trigger:
- main

pool:
  name: Default

steps:

# ================= API Gateway =================

- script: mvn test
  workingDirectory: api-gateway
  displayName: API Gateway - Run Tests

- task: Docker@2
  displayName: API Gateway - Build & Push
  inputs:
    command: buildAndPush
    containerRegistry: dockerhub
    repository: prashasthnaik/apigateway
    dockerfile: api-gateway/Dockerfile
    tags: latest


# ================= Eureka =================

- script: mvn test
  workingDirectory: eureka-server
  displayName: Eureka - Run Tests

- task: Docker@2
  displayName: Eureka - Build & Push
  inputs:
    command: buildAndPush
    containerRegistry: dockerhub
    repository: prashasthnaik/eureka
    dockerfile: eureka-server/Dockerfile
    tags: latest


# ================= Frontend =================

- script: |
    npm install
    npm test
  workingDirectory: frontend
  displayName: Frontend - Build & Test

- task: Docker@2
  displayName: Frontend - Build & Push
  inputs:
    command: buildAndPush
    containerRegistry: dockerhub
    repository: prashasthnaik/frontend
    dockerfile: frontend/Dockerfile
    tags: latest


# ================= Order Service =================

- script: mvn test
  workingDirectory: order-service
  displayName: Order Service - Run Tests

- task: Docker@2
  displayName: Order Service - Build & Push
  inputs:
    command: buildAndPush
    containerRegistry: dockerhub
    repository: prashasthnaik/order
    dockerfile: order-service/Dockerfile
    tags: latest


# ================= Product Service =================

- script: mvn test
  workingDirectory: product-service
  displayName: Product Service - Run Tests

- task: Docker@2
  displayName: Product Service - Build & Push
  inputs:
    command: buildAndPush
    containerRegistry: dockerhub
    repository: prashasthnaik/product
    dockerfile: product-service/Dockerfile
    tags: latest


# ================= User Service =================

- script: mvn test
  workingDirectory: user-service
  displayName: User Service - Run Tests

- task: Docker@2
  displayName: User Service - Build & Push
  inputs:
    command: buildAndPush
    containerRegistry: dockerhub
    repository: prashasthnaik/user
    dockerfile: user-service/Dockerfile
    tags: latest


# ================= Collect Test Reports =================

- script: |
    mkdir test-reports

    cp -r api-gateway/target/surefire-reports test-reports/api-gateway || true
    cp -r eureka-server/target/surefire-reports test-reports/eureka || true
    cp -r order-service/target/surefire-reports test-reports/order || true
    cp -r product-service/target/surefire-reports test-reports/product || true
    cp -r user-service/target/surefire-reports test-reports/user || true
    cp -r frontend/coverage test-reports/frontend || true

  displayName: Collect test reports


# ================= Commit & Push to BOTH repos =================

- script: |
    git config user.email "pipeline@azure.com"
    git config user.name "Azure Pipeline"

    git add test-reports azure-pipelines.yml
    git commit -m "Auto update test reports [CI]" || echo "Nothing to commit"

    # Push to Azure DevOps repo
    git push origin main

    # Push to GitHub repo
    git push https://$(GITHUB_TOKEN)@github.com/prashasth2002naik/Ecommerce-microservices-updated.git main

  displayName: Sync reports to Azure DevOps + GitHub
